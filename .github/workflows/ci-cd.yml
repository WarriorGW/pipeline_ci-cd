name: CI/CD - Kubernetes automated deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/myservice
  K8S_NAMESPACE: app-prod

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python for tests
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies (tests)
        run: |
          python -m pip install -r requirements.txt || true
          python -m pip install pytest

      - name: Run unit tests
        run: pytest tests/unit -q

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push image
        id: set-image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
      - name: Output image
        run: echo "image=${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy-and-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.3'

      - name: Setup Kubeconfig (from secret)
        run: |
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          mkdir -p $HOME/.kube && cp kubeconfig $HOME/.kube/config

      - name: Deploy (release) - apply manifests with new image
        env:
          IMAGE: ${{ needs.build.outputs.image }}
        run: |
          chmod +x ci/scripts/release.sh
          ci/scripts/release.sh "${IMAGE}"

      - name: Run integration tests
        run: pytest tests/integration -q || (echo "integration tests failed" && exit 1)

      - name: Monitor metrics for 5m and rollback if necessary
        env:
          PROM_URL: ${{ secrets.PROMETHEUS_URL }}
        run: |
          chmod +x ci/scripts/monitor_prometheus.sh
          ./ci/scripts/monitor_prometheus.sh

  promote-to-prod:
    needs: deploy-and-test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Promote to production (example: scale, route)
        run: |
          echo "Promotion step. In blue/green you should shift ingress LB to point to new pods gradually."

